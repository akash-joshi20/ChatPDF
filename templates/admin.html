<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatPDF Admin Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: #f5f7fa;
        color: #333;
      }

      .container {
        display: flex;
        min-height: 100vh;
      }

      .sidebar {
        width: 250px;
        background: #2c3e50;
        color: white;
        padding: 20px;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
      }

      .sidebar h2 {
        font-size: 20px;
        margin-bottom: 30px;
        color: #e74c3c;
      }

      .nav-menu {
        list-style: none;
      }

      .nav-menu li {
        margin-bottom: 15px;
      }

      .nav-menu button {
        width: 100%;
        padding: 12px;
        background: transparent;
        color: white;
        border: none;
        text-align: left;
        cursor: pointer;
        border-radius: 5px;
        transition: background 0.3s;
        font-size: 14px;
        font-weight: 500;
      }

      .nav-menu button:hover {
        background: #34495e;
      }

      .nav-menu button.active {
        background: #e74c3c;
      }

      .logout-btn {
        margin-top: 30px;
        padding: 10px;
        background: #c0392b;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        width: 100%;
        font-weight: bold;
      }

      .logout-btn:hover {
        background: #a93226;
      }

      .main-content {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      h1 {
        font-size: 28px;
        color: #2c3e50;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        border-left: 4px solid #e74c3c;
      }

      .stat-card h3 {
        font-size: 12px;
        text-transform: uppercase;
        color: #7f8c8d;
        margin-bottom: 10px;
      }

      .stat-card .value {
        font-size: 32px;
        font-weight: bold;
        color: #2c3e50;
      }

      .section {
        display: none;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .section.active {
        display: block;
      }

      .section h2 {
        margin-bottom: 20px;
        color: #2c3e50;
        font-size: 20px;
      }

      .search-box {
        margin-bottom: 20px;
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      th {
        background: #f1f1f1;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #2c3e50;
        border-bottom: 2px solid #ddd;
      }

      td {
        padding: 12px;
        border-bottom: 1px solid #eee;
      }

      tr:hover {
        background: #f9f9f9;
      }

      .action-btn {
        padding: 6px 12px;
        margin-right: 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        transition: opacity 0.2s;
      }

      .btn-delete {
        background: #e74c3c;
        color: white;
      }

      .btn-delete:hover {
        background: #c0392b;
      }

      .btn-ban {
        background: #f39c12;
        color: white;
      }

      .btn-ban:hover {
        background: #d68910;
      }

      .btn-unban {
        background: #27ae60;
        color: white;
      }

      .btn-unban:hover {
        background: #229954;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
      }

      .status-active {
        background: #d4edda;
        color: #155724;
      }

      .status-inactive {
        background: #f8d7da;
        color: #721c24;
      }

      .message {
        padding: 12px;
        border-radius: 5px;
        margin-bottom: 15px;
        font-size: 14px;
      }

      .message.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      @media (max-width: 768px) {
        .container {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .nav-menu {
          display: flex;
          flex-direction: row;
          gap: 10px;
        }

        .nav-menu li {
          margin-bottom: 0;
        }

        .nav-menu button {
          padding: 8px 12px;
          width: auto;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        table {
          font-size: 12px;
        }

        th,
        td {
          padding: 8px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <div class="sidebar">
        <h2>üîê Admin</h2>
        <ul class="nav-menu">
          <li>
            <button class="nav-btn active" onclick="switchTab('dashboard')">
              üìä Dashboard
            </button>
          </li>
          <li>
            <button class="nav-btn" onclick="switchTab('users')">
              üë• Users
            </button>
          </li>
          <li>
            <button class="nav-btn" onclick="switchTab('pdfs')">üìÑ PDFs</button>
          </li>
        </ul>
        <button class="logout-btn" onclick="logout()">üö™ Logout</button>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <header>
          <h1 id="page-title">Dashboard</h1>
          <span id="refresh-time">Updated: --:--</span>
        </header>

        <div id="message"></div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="section active">
          <div class="stats-grid" id="stats-container">
            <div class="stat-card">
              <h3>Total Users</h3>
              <div class="value" id="stat-users">0</div>
            </div>
            <div class="stat-card">
              <h3>Active Users</h3>
              <div class="value" id="stat-active">0</div>
            </div>
            <div class="stat-card">
              <h3>Total PDFs</h3>
              <div class="value" id="stat-pdfs">0</div>
            </div>
            <div class="stat-card">
              <h3>Total Chats</h3>
              <div class="value" id="stat-chats">0</div>
            </div>
            <div class="stat-card">
              <h3>Storage Used</h3>
              <div class="value" id="stat-storage">0 MB</div>
            </div>
          </div>
        </div>

        <!-- Users Section -->
        <div id="users" class="section">
          <h2>User Management</h2>
          <input
            type="text"
            id="user-search"
            class="search-box"
            placeholder="Search users by email..."
          />
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Email</th>
                <th>PDFs Uploaded</th>
                <th>Questions Asked</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="users-table"></tbody>
          </table>
        </div>

        <!-- PDFs Section -->
        <div id="pdfs" class="section">
          <h2>PDF Management</h2>
          <input
            type="text"
            id="pdf-search"
            class="search-box"
            placeholder="Search PDFs by filename..."
          />
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Filename</th>
                <th>Uploaded By</th>
                <th>Text Size</th>
                <th>Questions</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="pdfs-table"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        loadStats();
        loadUsers();
        loadPDFs();
      });

      function showMessage(text, type = "success") {
        const msgDiv = document.getElementById("message");
        msgDiv.className = `message ${type}`;
        msgDiv.textContent = text;
        setTimeout(() => (msgDiv.innerHTML = ""), 3000);
      }

      function updateTime() {
        const now = new Date();
        document.getElementById("refresh-time").textContent =
          `Updated: ${now.toLocaleTimeString()}`;
      }

      function switchTab(tab) {
        document
          .querySelectorAll(".section")
          .forEach((s) => s.classList.remove("active"));
        document
          .querySelectorAll(".nav-btn")
          .forEach((b) => b.classList.remove("active"));
        document.getElementById(tab).classList.add("active");
        event.target.classList.add("active");

        const titles = {
          dashboard: "Dashboard",
          users: "User Management",
          pdfs: "PDF Management",
        };
        document.getElementById("page-title").textContent = titles[tab];
      }

      async function loadStats() {
        try {
          const res = await fetch("/api/admin/stats");
          const data = await res.json();

          document.getElementById("stat-users").textContent = data.total_users;
          document.getElementById("stat-active").textContent =
            data.active_users;
          document.getElementById("stat-pdfs").textContent = data.total_pdfs;
          document.getElementById("stat-chats").textContent = data.total_chats;
          document.getElementById("stat-storage").textContent =
            data.storage_mb + " MB";
          updateTime();
        } catch (error) {
          console.error("Error loading stats:", error);
        }
      }

      async function loadUsers() {
        try {
          const res = await fetch("/api/admin/users");
          const users = await res.json();

          const tbody = document.getElementById("users-table");
          tbody.innerHTML = "";

          users.forEach((user) => {
            const row = document.createElement("tr");
            const status = user.is_active ? "Active" : "Banned";
            const statusClass = user.is_active
              ? "status-active"
              : "status-inactive";

            row.innerHTML = `
            <td>${user.id}</td>
            <td>${user.email}</td>
            <td>${user.pdf_count}</td>
            <td>${user.chat_count}</td>
            <td><span class="status-badge ${statusClass}">${status}</span></td>
            <td>
              ${
                user.is_active
                  ? `<button class="action-btn btn-ban" onclick="banUser(${user.id})">Ban</button>`
                  : `<button class="action-btn btn-unban" onclick="unbanUser(${user.id})">Unban</button>`
              }
              <button class="action-btn btn-delete" onclick="deleteUser(${user.id})">Delete</button>
            </td>
          `;
            tbody.appendChild(row);
          });
        } catch (error) {
          console.error("Error loading users:", error);
        }
      }

      async function loadPDFs() {
        try {
          const res = await fetch("/api/admin/pdfs");
          const pdfs = await res.json();

          const tbody = document.getElementById("pdfs-table");
          tbody.innerHTML = "";

          pdfs.forEach((pdf) => {
            const row = document.createElement("tr");
            const sizeKB = (pdf.text_size / 1024).toFixed(2);

            row.innerHTML = `
            <td>${pdf.id}</td>
            <td>${pdf.original_filename}</td>
            <td>${pdf.email}</td>
            <td>${sizeKB} KB</td>
            <td>${pdf.chat_count}</td>
            <td>
              <button class="action-btn btn-delete" onclick="deletePDF(${pdf.id})">Delete</button>
            </td>
          `;
            tbody.appendChild(row);
          });
        } catch (error) {
          console.error("Error loading PDFs:", error);
        }
      }

      async function banUser(userId) {
        if (!confirm("Ban this user?")) return;

        try {
          const res = await fetch(`/api/admin/users/${userId}/ban`, {
            method: "POST",
          });
          if (res.ok) {
            showMessage("User banned successfully");
            loadUsers();
          } else {
            showMessage("Failed to ban user", "error");
          }
        } catch (error) {
          showMessage("Error: " + error.message, "error");
        }
      }

      async function unbanUser(userId) {
        if (!confirm("Unban this user?")) return;

        try {
          const res = await fetch(`/api/admin/users/${userId}/unban`, {
            method: "POST",
          });
          if (res.ok) {
            showMessage("User unbanned successfully");
            loadUsers();
          } else {
            showMessage("Failed to unban user", "error");
          }
        } catch (error) {
          showMessage("Error: " + error.message, "error");
        }
      }

      async function deleteUser(userId) {
        if (
          !confirm(
            "‚ö†Ô∏è Delete this user? This will remove all their PDFs and chat history.",
          )
        )
          return;

        try {
          const res = await fetch(`/api/admin/users/${userId}/delete`, {
            method: "POST",
          });
          if (res.ok) {
            showMessage("User deleted successfully");
            loadUsers();
            loadStats();
          } else {
            showMessage("Failed to delete user", "error");
          }
        } catch (error) {
          showMessage("Error: " + error.message, "error");
        }
      }

      async function deletePDF(pdfId) {
        if (!confirm("Delete this PDF?")) return;

        try {
          const res = await fetch(`/api/admin/pdfs/${pdfId}/delete`, {
            method: "POST",
          });
          if (res.ok) {
            showMessage("PDF deleted successfully");
            loadPDFs();
            loadStats();
          } else {
            showMessage("Failed to delete PDF", "error");
          }
        } catch (error) {
          showMessage("Error: " + error.message, "error");
        }
      }

      async function logout() {
        await fetch("/logout", { method: "POST" });
        window.location.href = "/auth";
      }

      // Search functionality
      document
        .getElementById("user-search")
        .addEventListener("keyup", function () {
          const search = this.value.toLowerCase();
          document.querySelectorAll("#users-table tr").forEach((row) => {
            const email = row.cells[1].textContent.toLowerCase();
            row.style.display = email.includes(search) ? "" : "none";
          });
        });

      document
        .getElementById("pdf-search")
        .addEventListener("keyup", function () {
          const search = this.value.toLowerCase();
          document.querySelectorAll("#pdfs-table tr").forEach((row) => {
            const filename = row.cells[1].textContent.toLowerCase();
            row.style.display = filename.includes(search) ? "" : "none";
          });
        });
    </script>
  </body>
</html>
